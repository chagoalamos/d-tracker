<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D Tracker Pro | Mi Bitácora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        crOrange: '#f47521',
                        crBlack: '#23252b',
                        crDarkGrey: '#141519',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { transition: background-color 0.3s, color 0.3s; }
        .anime-card { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .dark .anime-card { background-color: #23252b; }
        .light .anime-card { background-color: #ffffff; border: 1px solid #e5e7eb; }
        .anime-card:hover { transform: translateY(-5px); border-color: #f47521; }
        .poster-container { aspect-ratio: 2 / 3; overflow: hidden; position: relative; }
        .poster-image { width: 100%; height: 100%; object-fit: cover; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        
        .cr-badge {
            background: linear-gradient(90deg, #f47521, #cb5a0b);
            box-shadow: 0 2px 10px rgba(244, 117, 33, 0.4);
        }

        /* Animación para el Toast */
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        /* Estilo del Logo de Luffy */
        .luffy-logo {
            filter: drop-shadow(0 0 2px rgba(244, 117, 33, 0.5));
            transition: transform 0.3s ease;
        }
        .luffy-logo:hover {
            transform: scale(1.1) rotate(5deg);
        }
    </style>
</head>
<body class="dark bg-crDarkGrey text-white min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white dark:bg-crBlack border-b border-gray-200 dark:border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 h-20 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <!-- Logo de Luffy (SVG) -->
                <div class="luffy-logo w-12 h-12 flex items-center justify-center">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                        <!-- Sombrero de Paja -->
                        <path d="M10,60 Q10,35 50,35 Q90,35 90,60" fill="#f4d03f" stroke="#000" stroke-width="2"/>
                        <rect x="25" y="52" width="50" height="8" fill="#e74c3c" stroke="#000" stroke-width="1"/>
                        <!-- Cara -->
                        <path d="M25,60 Q25,85 50,85 Q75,85 75,60" fill="#fdebd0" stroke="#000" stroke-width="2"/>
                        <!-- Ojos -->
                        <circle cx="40" cy="65" r="3" fill="#000"/>
                        <circle cx="60" cy="65" r="3" fill="#000"/>
                        <!-- Cicatriz -->
                        <path d="M35,72 L45,72 M40,70 L40,74" stroke="#000" stroke-width="1"/>
                        <!-- Gran Sonrisa -->
                        <path d="M35,75 Q50,82 65,75" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-black tracking-tighter uppercase italic text-black dark:text-white">D <span class="text-crOrange">Tracker</span></h1>
            </div>

            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" oninput="loadSeries()" placeholder="Buscar en mi colección..." 
                    class="w-full bg-gray-100 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded-full py-2 px-10 outline-none focus:border-crOrange text-black dark:text-white">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
                <button onclick="openTrashModal()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 relative">
                    <i class="fas fa-trash-alt"></i>
                    <span id="trashCount" class="absolute -top-1 -right-1 bg-crOrange text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold hidden">0</span>
                </button>
                <button onclick="openModal()" class="bg-crOrange text-white px-4 py-2 rounded font-bold uppercase text-xs flex items-center gap-2 hover:brightness-110 transition-all">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">Nueva Serie</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6 flex-grow">
        <!-- Panel de Estadísticas -->
        <section id="statsPanel" class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-100 dark:bg-crBlack p-4 rounded-xl border border-gray-200 dark:border-gray-800 text-black dark:text-white">
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Total</p>
                <p id="statTotal" class="text-2xl font-black text-crOrange">0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Vistos</p>
                <p id="statVisto" class="text-2xl font-black text-green-500">0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Promedio</p>
                <p id="statAvg" class="text-2xl font-black text-yellow-500">0.0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Episodios</p>
                <p id="statEps" class="text-2xl font-black text-blue-500">0</p>
            </div>
        </section>

        <!-- Filtros -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div class="flex flex-wrap gap-2 items-center">
                <button onclick="setFilterStatus('all')" id="status-all" class="filter-btn-status px-4 py-1.5 rounded-full text-xs font-bold border-2 border-crOrange bg-crOrange text-white">Todos</button>
                <button onclick="setFilterStatus('visto')" id="status-visto" class="filter-btn-status px-4 py-1.5 rounded-full text-xs font-bold border-2 border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-400">Vistos</button>
                <button onclick="setFilterStatus('pendiente')" id="status-pendiente" class="filter-btn-status px-4 py-1.5 rounded-full text-xs font-bold border-2 border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-400">Pendientes</button>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Ordenar:</span>
                <select id="sortSelect" onchange="loadSeries()" class="bg-white dark:bg-crBlack border border-gray-300 dark:border-gray-700 rounded p-1.5 text-xs text-black dark:text-white outline-none">
                    <option value="recent">Recientes</option>
                    <option value="alpha">A-Z</option>
                    <option value="rating">Mejor Nota</option>
                </select>
            </div>
        </div>

        <!-- Grid -->
        <div id="seriesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
        <div id="emptyState" class="hidden text-center py-20">
            <i class="fas fa-search text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
            <p class="text-xl text-gray-500 font-medium italic">No se encontraron resultados...</p>
        </div>
    </main>

    <!-- Notificación Deshacer -->
    <div id="undoToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] hidden">
        <div class="bg-crBlack border border-gray-700 shadow-2xl rounded-full px-6 py-3 flex items-center gap-4 animate-slide-up">
            <span class="text-sm font-medium">Serie movida a la papelera</span>
            <div class="h-4 w-[1px] bg-gray-700"></div>
            <button onclick="undoDelete()" class="text-crOrange font-black text-xs uppercase tracking-widest hover:text-white transition-colors">
                <i class="fas fa-undo-alt mr-1"></i> Deshacer
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-crBlack border-t border-gray-200 dark:border-gray-800 py-8 mt-12">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-6 text-center md:text-left">
            <div class="flex gap-4">
                <button onclick="exportData()" class="text-gray-600 dark:text-gray-400 hover:text-crOrange text-xs font-bold uppercase flex items-center gap-2 transition-colors">
                    <i class="fas fa-download"></i> Exportar JSON
                </button>
                <label class="text-gray-600 dark:text-gray-400 hover:text-crOrange text-xs font-bold uppercase flex items-center gap-2 cursor-pointer transition-colors">
                    <i class="fas fa-upload"></i> Importar JSON
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                </label>
            </div>
            <p class="text-gray-400 text-[10px] uppercase tracking-[0.2em]">D Tracker Pro &copy; 2026</p>
        </div>
    </footer>

    <!-- Modal Formulario -->
    <div id="modal" class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-crBlack w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
            <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-crBlack">
                <h2 id="modalTitle" class="text-xl font-black italic uppercase text-black dark:text-white">Detalles de Serie</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-crOrange transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="seriesForm" class="p-6 space-y-4 max-h-[75vh] overflow-y-auto no-scrollbar">
                <input type="hidden" id="editingId" value="">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Título</label>
                        <div class="flex gap-2">
                            <input type="text" id="title" required class="flex-1 bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white focus:border-crOrange outline-none">
                            <button type="button" onclick="autoFetchAnime()" id="magicBtn" class="bg-gray-200 dark:bg-gray-700 px-3 rounded text-crOrange hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Crunchyroll URL (Opcional)</label>
                        <input type="url" id="crUrl" placeholder="Enlace directo al anime..." class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white focus:border-crOrange outline-none text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Imagen URL</label>
                        <input type="url" id="imageUrl" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white focus:border-crOrange outline-none text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Estado</label>
                            <select id="status" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white outline-none">
                                <option value="pendiente">Pendiente</option>
                                <option value="visto">Visto</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Episodios</label>
                            <input type="number" id="episodes" value="0" min="0" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white outline-none">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Calificación</label>
                    <div id="starRatingContainer" class="flex items-center gap-1.5 mt-1"></div>
                    <input type="hidden" id="rating" value="5">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Reseña / Notas</label>
                    <textarea id="notes" rows="3" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-3 text-black dark:text-white focus:border-crOrange outline-none resize-none" placeholder="¿Qué te pareció esta serie?"></textarea>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 text-gray-500 font-bold uppercase text-xs tracking-widest hover:text-black dark:hover:text-white transition-colors">Cerrar</button>
                    <button type="submit" id="submitBtn" class="flex-1 bg-crOrange text-white py-3 rounded-lg font-black uppercase text-xs tracking-widest shadow-lg shadow-orange-500/20 hover:brightness-110 transition-all">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Papelera -->
    <div id="trashModal" class="fixed inset-0 modal-bg z-[110] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-crBlack w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
            <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-crBlack">
                <h2 class="text-xl font-black uppercase italic text-black dark:text-white"><i class="fas fa-trash-alt mr-2 text-crOrange"></i> Papelera</h2>
                <button onclick="closeTrashModal()" class="text-gray-400 hover:text-crOrange transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="trashList" class="p-6 max-h-[60vh] overflow-y-auto space-y-3 no-scrollbar bg-white dark:bg-crBlack"></div>
            <div class="p-4 bg-gray-50 dark:bg-crDarkGrey border-t border-gray-200 dark:border-gray-800 flex justify-end gap-2">
                <button onclick="emptyTrash()" class="text-red-500 text-[10px] font-bold uppercase tracking-widest px-4 py-2 hover:bg-red-500/10 rounded transition-colors">Vaciar permanentemente</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'DTrackerProDB';
        const DB_VERSION = 4;
        const STORE_NAME = 'series';
        const TRASH_STORE = 'trash';
        let db;
        let currentFilterStatus = 'all';
        let undoTimeout;
        let lastDeletedId = null;

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            document.body.classList.toggle('light');
            document.getElementById('themeIcon').className = isDark ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('dtracker-theme', isDark ? 'dark' : 'light');
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            if (!db.objectStoreNames.contains(TRASH_STORE)) db.createObjectStore(TRASH_STORE, { keyPath: 'id' });
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            if(localStorage.getItem('dtracker-theme') === 'light') toggleTheme();
            loadSeries();
            updateTrashBadge();
        };

        function setupStarRating(val = 5) {
            const container = document.getElementById('starRatingContainer');
            container.innerHTML = '';
            document.getElementById('rating').value = val;
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = `fas fa-star text-lg cursor-pointer transition-colors ${i <= val ? 'text-yellow-500' : 'text-gray-300 dark:text-gray-600'}`;
                star.onclick = () => setupStarRating(i);
                container.appendChild(star);
            }
        }

        async function autoFetchAnime() {
            const titleInput = document.getElementById('title');
            const title = titleInput.value;
            if (!title) return;
            const magicBtn = document.getElementById('magicBtn');
            magicBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1`);
                const { data } = await res.json();
                if (data && data[0]) {
                    document.getElementById('imageUrl').value = data[0].images.jpg.large_image_url;
                    if(!document.getElementById('notes').value) {
                        document.getElementById('notes').value = data[0].synopsis ? data[0].synopsis.substring(0, 150) + '...' : '';
                    }
                }
            } catch (err) { console.error(err); }
            magicBtn.innerHTML = '<i class="fas fa-magic"></i>';
        }

        function openModal(id = null) {
            document.getElementById('seriesForm').reset();
            document.getElementById('editingId').value = '';
            document.getElementById('modalTitle').innerText = "Añadir Serie";
            setupStarRating(5);
            if (id) {
                db.transaction([STORE_NAME]).objectStore(STORE_NAME).get(Number(id)).onsuccess = (e) => {
                    const data = e.target.result;
                    if(data) {
                        document.getElementById('editingId').value = data.id;
                        document.getElementById('title').value = data.title;
                        document.getElementById('status').value = data.status;
                        document.getElementById('imageUrl').value = data.imageUrl;
                        document.getElementById('episodes').value = data.episodes || 0;
                        document.getElementById('notes').value = data.notes || '';
                        document.getElementById('crUrl').value = data.crUrl || '';
                        setupStarRating(data.rating || 5);
                        document.getElementById('modalTitle').innerText = "Editar Serie";
                    }
                };
            }
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        document.getElementById('seriesForm').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('editingId').value;
            const data = {
                title: document.getElementById('title').value,
                status: document.getElementById('status').value,
                rating: parseInt(document.getElementById('rating').value),
                episodes: parseInt(document.getElementById('episodes').value) || 0,
                notes: document.getElementById('notes').value,
                crUrl: document.getElementById('crUrl').value,
                imageUrl: document.getElementById('imageUrl').value || 'https://via.placeholder.com/300x450?text=No+Image',
                updatedAt: new Date().toISOString()
            };
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            if (id) { data.id = Number(id); store.put(data); }
            else { data.createdAt = new Date().toISOString(); store.add(data); }
            tx.oncomplete = () => { closeModal(); loadSeries(); };
        };

        function setFilterStatus(status) {
            currentFilterStatus = status;
            document.querySelectorAll('.filter-btn-status').forEach(btn => {
                btn.classList.remove('border-crOrange', 'bg-crOrange', 'text-white');
                btn.classList.add('border-gray-300', 'dark:border-gray-700', 'text-gray-600', 'dark:text-gray-400');
            });
            document.getElementById(`status-${status}`).classList.add('border-crOrange', 'bg-crOrange', 'text-white');
            loadSeries();
        }

        function loadSeries() {
            if(!db) return;
            db.transaction([STORE_NAME]).objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                let series = e.target.result;
                const search = document.getElementById('searchInput').value.toLowerCase();
                const sort = document.getElementById('sortSelect').value;

                if (currentFilterStatus !== 'all') series = series.filter(s => s.status === currentFilterStatus);
                if (search) series = series.filter(s => s.title.toLowerCase().includes(search));

                if (sort === 'alpha') series.sort((a, b) => a.title.localeCompare(b.title));
                else if (sort === 'rating') series.sort((a, b) => b.rating - a.rating);
                else series.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));

                updateStats(e.target.result);
                renderGrid(series);
            };
        }

        function renderGrid(series) {
            const grid = document.getElementById('seriesGrid');
            const empty = document.getElementById('emptyState');
            grid.innerHTML = '';
            
            if (series.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            series.forEach(item => {
                const crLink = item.crUrl ? item.crUrl : `https://www.crunchyroll.com/search?q=${encodeURIComponent(item.title)}`;
                const card = document.createElement('div');
                card.className = 'anime-card rounded-xl overflow-hidden relative group flex flex-col shadow-lg cursor-pointer';
                card.onclick = () => openModal(item.id);
                
                card.innerHTML = `
                    <div class="poster-container">
                        <img src="${item.imageUrl}" class="poster-image transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/300x450?text=Error'">
                        <div class="absolute top-2 left-2 z-10">
                            <span class="cr-badge text-[8px] font-black text-white px-2 py-1 rounded shadow-lg uppercase tracking-wider flex items-center gap-1">
                                <i class="fas fa-play-circle"></i> En CR
                            </span>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col justify-end p-3">
                            <a href="${crLink}" target="_blank" onclick="event.stopPropagation()" class="bg-crOrange hover:bg-white hover:text-crOrange text-white text-[10px] font-black py-2 rounded mb-2 text-center transition-all uppercase">
                                <i class="fas fa-external-link-alt mr-1"></i> Ver Capítulo
                            </a>
                            <p class="text-[9px] text-gray-300 line-clamp-2 italic mb-1">${item.notes || 'Sin notas...'}</p>
                        </div>
                        <div class="absolute top-2 right-2 flex flex-col gap-1 z-20">
                            <button onclick="event.stopPropagation(); moveToTrash(${item.id})" class="bg-black/60 hover:bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center transition-colors">
                                <i class="fas fa-trash-alt text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3 bg-white dark:bg-crBlack">
                        <h3 class="font-bold text-xs truncate mb-1 text-black dark:text-white">${item.title}</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-[9px] font-black uppercase px-1.5 py-0.5 rounded ${item.status === 'visto' ? 'bg-green-500/10 text-green-500' : 'bg-blue-500/10 text-blue-500'}">
                                Ep: ${item.episodes || 0}
                            </span>
                            <div class="flex text-[8px] text-yellow-500">
                                ${Array(5).fill(0).map((_, i) => `<i class="${i < item.rating ? 'fas' : 'far'} fa-star"></i>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function moveToTrash(id) {
            const tx = db.transaction([STORE_NAME, TRASH_STORE], 'readwrite');
            const seriesStore = tx.objectStore(STORE_NAME);
            const trashStore = tx.objectStore(TRASH_STORE);
            seriesStore.get(id).onsuccess = (e) => {
                const item = e.target.result;
                if (item) {
                    trashStore.put(item);
                    seriesStore.delete(id);
                    lastDeletedId = id;
                    showUndoToast();
                }
            };
            tx.oncomplete = () => { loadSeries(); updateTrashBadge(); };
        }

        function showUndoToast() {
            const toast = document.getElementById('undoToast');
            toast.classList.remove('hidden');
            clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => toast.classList.add('hidden'), 6000);
        }

        function undoDelete() {
            if (!lastDeletedId) return;
            const tx = db.transaction([STORE_NAME, TRASH_STORE], 'readwrite');
            const seriesStore = tx.objectStore(STORE_NAME);
            const trashStore = tx.objectStore(TRASH_STORE);
            trashStore.get(lastDeletedId).onsuccess = (e) => {
                const item = e.target.result;
                if (item) {
                    seriesStore.add(item);
                    trashStore.delete(lastDeletedId);
                }
            };
            tx.oncomplete = () => {
                document.getElementById('undoToast').classList.add('hidden');
                loadSeries(); updateTrashBadge(); lastDeletedId = null;
            };
        }

        function openTrashModal() { renderTrashList(); document.getElementById('trashModal').classList.remove('hidden'); }

        function renderTrashList() {
            const list = document.getElementById('trashList');
            list.innerHTML = '';
            db.transaction([TRASH_STORE]).objectStore(TRASH_STORE).getAll().onsuccess = (e) => {
                const items = e.target.result;
                if (items.length === 0) list.innerHTML = '<p class="text-center text-gray-500 py-10 italic">La papelera está vacía</p>';
                else items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-crDarkGrey rounded-xl border border-gray-200 dark:border-gray-800';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${item.imageUrl}" class="w-10 h-14 object-cover rounded shadow" onerror="this.src='https://via.placeholder.com/100'">
                            <p class="font-bold text-xs text-black dark:text-white">${item.title}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="restoreFromTrash(${item.id})" class="p-2 text-green-500 hover:bg-green-500/10 rounded-lg transition-colors"><i class="fas fa-undo"></i></button>
                            <button onclick="permanentDelete(${item.id})" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"><i class="fas fa-times-circle"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            };
        }

        function restoreFromTrash(id) {
            const tx = db.transaction([STORE_NAME, TRASH_STORE], 'readwrite');
            const trashStore = tx.objectStore(TRASH_STORE);
            const seriesStore = tx.objectStore(STORE_NAME);
            trashStore.get(id).onsuccess = (e) => {
                const item = e.target.result;
                if(item) { seriesStore.add(item); trashStore.delete(id); }
            };
            tx.oncomplete = () => { renderTrashList(); loadSeries(); updateTrashBadge(); };
        }

        function permanentDelete(id) {
            if (!confirm('¿Eliminar permanentemente?')) return;
            const tx = db.transaction([TRASH_STORE], 'readwrite');
            tx.objectStore(TRASH_STORE).delete(id);
            tx.oncomplete = () => { renderTrashList(); updateTrashBadge(); };
        }

        function emptyTrash() {
            if (!confirm('¿Vaciar papelera?')) return;
            const tx = db.transaction([TRASH_STORE], 'readwrite');
            tx.objectStore(TRASH_STORE).clear();
            tx.oncomplete = () => { renderTrashList(); updateTrashBadge(); };
        }

        function updateTrashBadge() {
            if(!db) return;
            db.transaction([TRASH_STORE]).objectStore(TRASH_STORE).count().onsuccess = (e) => {
                const count = e.target.result;
                const badge = document.getElementById('trashCount');
                badge.innerText = count;
                badge.classList.toggle('hidden', count === 0);
            };
        }

        function closeTrashModal() { document.getElementById('trashModal').classList.add('hidden'); }

        function updateStats(all) {
            document.getElementById('statTotal').innerText = all.length;
            document.getElementById('statVisto').innerText = all.filter(s => s.status === 'visto').length;
            document.getElementById('statEps').innerText = all.reduce((acc, curr) => acc + (curr.episodes || 0), 0);
            document.getElementById('statAvg').innerText = all.length > 0 ? (all.reduce((acc, curr) => acc + curr.rating, 0) / all.length).toFixed(1) : "0.0";
        }

        function getFormattedDate() {
            const now = new Date();
            const dd = String(now.getDate()).padStart(2, '0');
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yyyy = now.getFullYear();
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            return `${dd}-${mm}-${yyyy}_${hh}-${min}`;
        }

        function exportData() {
            db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                const blob = new Blob([JSON.stringify(e.target.result, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `d-tracker-backup_${getFormattedDate()}.json`;
                a.click();
            };
        }

        function importData(input) {
            if(!input.files.length) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    data.forEach(item => { const ni = {...item}; delete ni.id; store.add(ni); });
                    tx.oncomplete = () => loadSeries();
                } catch(err) { alert("Archivo JSON no válido"); }
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>