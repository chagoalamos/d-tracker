<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D Tracker Pro | Mi Bitácora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        crOrange: '#f47521',
                        crBlack: '#23252b',
                        crDarkGrey: '#141519',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { transition: background-color 0.3s, color 0.3s; }
        
        .anime-card {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .dark .anime-card { background-color: #23252b; }
        .light .anime-card { background-color: #ffffff; border: 1px solid #e5e7eb; }

        .anime-card:hover {
            transform: translateY(-5px);
            border-color: #f47521;
        }

        .poster-container { aspect-ratio: 2 / 3; overflow: hidden; }
        .poster-image { width: 100%; height: 100%; object-fit: cover; }
        
        .modal-bg { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="dark bg-crDarkGrey text-white min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white dark:bg-crBlack border-b border-gray-200 dark:border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 h-20 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <i class="fas fa-layer-group text-3xl text-crOrange"></i>
                <h1 class="text-2xl font-black tracking-tighter uppercase italic text-black dark:text-white">D <span class="text-crOrange">Tracker</span></h1>
            </div>

            <!-- Buscador -->
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" oninput="loadSeries()" placeholder="Buscar en mi colección..." 
                    class="w-full bg-gray-100 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded-full py-2 px-10 outline-none focus:border-crOrange text-black dark:text-white">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
                <button onclick="openModal()" class="bg-crOrange text-white px-4 py-2 rounded font-bold uppercase text-xs flex items-center gap-2 hover:brightness-110 transition-all">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">Nueva Serie</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6 flex-grow">
        
        <!-- Panel de Estadísticas -->
        <section id="statsPanel" class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-100 dark:bg-crBlack p-4 rounded-xl border border-gray-200 dark:border-gray-800">
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Total</p>
                <p id="statTotal" class="text-2xl font-black text-crOrange">0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Vistos</p>
                <p id="statVisto" class="text-2xl font-black text-green-500">0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Promedio</p>
                <p id="statAvg" class="text-2xl font-black text-yellow-500">0.0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500">Episodios</p>
                <p id="statEps" class="text-2xl font-black text-blue-500">0</p>
            </div>
        </section>

        <!-- Filtros y Ordenación -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div class="flex flex-wrap gap-2 items-center">
                <button onclick="setFilterStatus('all')" id="status-all" class="filter-btn-status px-4 py-1.5 rounded-full text-xs font-bold border-2 border-crOrange bg-crOrange text-white">Todos</button>
                <button onclick="setFilterStatus('visto')" id="status-visto" class="filter-btn-status px-4 py-1.5 rounded-full text-xs font-bold border-2 border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-400">Vistos</button>
                <button onclick="setFilterStatus('pendiente')" id="status-pendiente" class="filter-btn-status px-4 py-1.5 rounded-full text-xs font-bold border-2 border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-400">Pendientes</button>
            </div>

            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Ordenar:</span>
                <select id="sortSelect" onchange="loadSeries()" class="bg-white dark:bg-crBlack border border-gray-300 dark:border-gray-700 rounded p-1.5 text-xs text-black dark:text-white outline-none">
                    <option value="recent">Recientes</option>
                    <option value="alpha">A-Z</option>
                    <option value="rating">Mejor Nota</option>
                </select>
            </div>
        </div>

        <!-- Grid -->
        <div id="seriesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <!-- Inyectado por JS -->
        </div>

        <div id="emptyState" class="hidden text-center py-20">
            <i class="fas fa-search text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
            <p class="text-xl text-gray-500 font-medium italic">No se encontraron resultados...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-crBlack border-t border-gray-200 dark:border-gray-800 py-8 mt-12">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex gap-4">
                <button onclick="exportData()" class="text-gray-600 dark:text-gray-400 hover:text-crOrange text-xs font-bold uppercase flex items-center gap-2 transition-colors">
                    <i class="fas fa-download"></i> Exportar JSON
                </button>
                <label class="text-gray-600 dark:text-gray-400 hover:text-crOrange text-xs font-bold uppercase flex items-center gap-2 cursor-pointer transition-colors">
                    <i class="fas fa-upload"></i> Importar JSON
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                </label>
            </div>
            <p class="text-gray-400 text-[10px] uppercase tracking-[0.2em]">D Tracker Pro &copy; 2024</p>
        </div>
    </footer>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-crBlack w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
            <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-crBlack">
                <h2 id="modalTitle" class="text-xl font-black italic uppercase text-black dark:text-white">Añadir Serie</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-crOrange transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="seriesForm" class="p-6 space-y-4 max-h-[75vh] overflow-y-auto no-scrollbar">
                <input type="hidden" id="editingId" value="">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Título</label>
                        <div class="flex gap-2">
                            <input type="text" id="title" required class="flex-1 bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white focus:border-crOrange outline-none">
                            <button type="button" onclick="autoFetchAnime()" id="magicBtn" class="bg-gray-200 dark:bg-gray-700 px-3 rounded text-crOrange hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Imagen URL</label>
                        <input type="url" id="imageUrl" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white focus:border-crOrange outline-none text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Estado</label>
                        <select id="status" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white outline-none">
                            <option value="pendiente">Pendiente</option>
                            <option value="visto">Visto</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Episodios</label>
                        <input type="number" id="episodes" value="0" min="0" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-2 text-black dark:text-white outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Calificación</label>
                        <div id="starRatingContainer" class="flex items-center gap-1.5 mt-1 text-gray-300 dark:text-gray-600">
                            <!-- Estrellas -->
                        </div>
                        <input type="hidden" id="rating" value="5">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-widest">Reseña / Notas Personales</label>
                    <textarea id="notes" rows="3" class="w-full bg-gray-50 dark:bg-crDarkGrey border border-gray-300 dark:border-gray-700 rounded p-3 text-black dark:text-white focus:border-crOrange outline-none resize-none" placeholder="¿Qué te pareció esta serie?"></textarea>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 text-gray-500 font-bold uppercase text-xs tracking-widest hover:text-black dark:hover:text-white transition-colors">Cerrar</button>
                    <button type="submit" id="submitBtn" class="flex-1 bg-crOrange text-white py-3 rounded-lg font-black uppercase text-xs tracking-widest shadow-lg shadow-orange-500/20 hover:brightness-110 transition-all">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const DB_NAME = 'DTrackerProDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'series';
        let db;
        
        let currentFilterStatus = 'all';

        // Tema
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            document.body.classList.toggle('light');
            document.getElementById('themeIcon').className = isDark ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('dtracker-theme', isDark ? 'dark' : 'light');
        }

        // Inicializar DB
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            if(localStorage.getItem('dtracker-theme') === 'light') toggleTheme();
            loadSeries();
        };

        // UI Estrellas
        function setupStarRating(val = 5) {
            const container = document.getElementById('starRatingContainer');
            container.innerHTML = '';
            document.getElementById('rating').value = val;

            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = `fas fa-star text-lg cursor-pointer transition-colors ${i <= val ? 'text-yellow-500' : 'text-gray-300 dark:text-gray-600'}`;
                star.onclick = () => setupStarRating(i);
                container.appendChild(star);
            }
        }

        // Fetch API
        async function autoFetchAnime() {
            const title = document.getElementById('title').value;
            if (!title) return;
            const magicBtn = document.getElementById('magicBtn');
            magicBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1`);
                const { data } = await res.json();
                if (data && data[0]) {
                    document.getElementById('imageUrl').value = data[0].images.jpg.large_image_url;
                    if(!document.getElementById('notes').value) {
                        document.getElementById('notes').value = data[0].synopsis ? data[0].synopsis.substring(0, 150) + '...' : '';
                    }
                }
            } catch (err) { console.error(err); }
            magicBtn.innerHTML = '<i class="fas fa-magic"></i>';
        }

        // CRUD
        function openModal(id = null) {
            const form = document.getElementById('seriesForm');
            form.reset();
            document.getElementById('editingId').value = '';
            document.getElementById('modalTitle').innerText = "Añadir Serie";
            setupStarRating(5);

            if (id) {
                const store = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME);
                store.get(Number(id)).onsuccess = (e) => {
                    const data = e.target.result;
                    document.getElementById('editingId').value = data.id;
                    document.getElementById('title').value = data.title;
                    document.getElementById('status').value = data.status;
                    document.getElementById('imageUrl').value = data.imageUrl;
                    document.getElementById('episodes').value = data.episodes || 0;
                    document.getElementById('notes').value = data.notes || '';
                    setupStarRating(data.rating || 5);
                    document.getElementById('modalTitle').innerText = "Editar Serie";
                };
            }
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        document.getElementById('seriesForm').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('editingId').value;
            const data = {
                title: document.getElementById('title').value,
                status: document.getElementById('status').value,
                rating: parseInt(document.getElementById('rating').value),
                episodes: parseInt(document.getElementById('episodes').value) || 0,
                notes: document.getElementById('notes').value,
                imageUrl: document.getElementById('imageUrl').value || 'https://via.placeholder.com/300x450?text=No+Image',
                updatedAt: new Date().toISOString()
            };

            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            if (id) { data.id = Number(id); store.put(data); }
            else { data.createdAt = new Date().toISOString(); store.add(data); }
            tx.oncomplete = () => { closeModal(); loadSeries(); };
        };

        function setFilterStatus(status) {
            currentFilterStatus = status;
            document.querySelectorAll('.filter-btn-status').forEach(btn => {
                btn.classList.remove('border-crOrange', 'bg-crOrange', 'text-white');
                btn.classList.add('border-gray-300', 'dark:border-gray-700', 'text-gray-600', 'dark:text-gray-400');
            });
            document.getElementById(`status-${status}`).classList.add('border-crOrange', 'bg-crOrange', 'text-white');
            loadSeries();
        }

        function loadSeries() {
            const request = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).getAll();
            request.onsuccess = () => {
                let series = request.result;
                const search = document.getElementById('searchInput').value.toLowerCase();
                const sort = document.getElementById('sortSelect').value;

                // Filtrar
                if (currentFilterStatus !== 'all') series = series.filter(s => s.status === currentFilterStatus);
                if (search) series = series.filter(s => s.title.toLowerCase().includes(search));

                // Ordenar
                if (sort === 'alpha') series.sort((a, b) => a.title.localeCompare(b.title));
                else if (sort === 'rating') series.sort((a, b) => b.rating - a.rating);
                else series.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));

                updateStats(request.result);
                renderGrid(series);
            };
        }

        function updateStats(all) {
            const total = all.length;
            const visto = all.filter(s => s.status === 'visto').length;
            const eps = all.reduce((acc, curr) => acc + (curr.episodes || 0), 0);
            const avg = total > 0 ? (all.reduce((acc, curr) => acc + curr.rating, 0) / total).toFixed(1) : "0.0";

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statVisto').innerText = visto;
            document.getElementById('statAvg').innerText = avg;
            document.getElementById('statEps').innerText = eps;
        }

        function renderGrid(series) {
            const grid = document.getElementById('seriesGrid');
            const empty = document.getElementById('emptyState');
            grid.innerHTML = '';
            
            if (series.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            series.forEach(item => {
                const card = document.createElement('div');
                card.className = 'anime-card rounded-xl overflow-hidden relative group flex flex-col shadow-lg cursor-pointer';
                card.onclick = () => openModal(item.id);
                
                card.innerHTML = `
                    <div class="poster-container relative">
                        <img src="${item.imageUrl}" class="poster-image transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/300x450?text=Error'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3">
                            <p class="text-[10px] text-gray-300 line-clamp-3 italic">${item.notes || 'Sin notas...'}</p>
                        </div>
                        <div class="absolute top-2 right-2 flex flex-col gap-1">
                            <button onclick="event.stopPropagation(); deleteSeries(${item.id})" class="bg-black/60 hover:bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center transition-colors">
                                <i class="fas fa-trash-alt text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3 bg-white dark:bg-crBlack">
                        <h3 class="font-bold text-xs truncate mb-1 text-black dark:text-white">${item.title}</h3>
                        <div class="flex items-center justify-between gap-1">
                            <span class="text-[9px] font-black tracking-tighter uppercase px-1.5 py-0.5 rounded ${item.status === 'visto' ? 'bg-green-500/10 text-green-500' : 'bg-blue-500/10 text-blue-500'}">
                                Ep: ${item.episodes || 0}
                            </span>
                            <div class="flex text-[9px] text-yellow-500">
                                ${Array(5).fill(0).map((_, i) => `<i class="${i < item.rating ? 'fas' : 'far'} fa-star"></i>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function deleteSeries(id) {
            if(!confirm('¿Eliminar serie?')) return;
            const tx = db.transaction([STORE_NAME], 'readwrite');
            tx.objectStore(STORE_NAME).delete(id);
            tx.oncomplete = () => loadSeries();
        }

        // Export/Import
        function exportData() {
            db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                const timestamp = `${day}-${month}-${year}_${hours}-${minutes}`;
                const fileName = `d-tracker-backup_${timestamp}.json`;

                const blob = new Blob([JSON.stringify(e.target.result, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                a.click();
            };
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                data.forEach(item => { delete item.id; store.add(item); });
                tx.oncomplete = () => loadSeries();
            };
            reader.readAsText(input.files[0]);
        }

        setupStarRating(5);
    </script>
</body>
</html>