<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D Tracker | Mi Bitácora de Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --cr-orange: #f47521;
            --cr-black: #23252b;
            --cr-dark-grey: #141519;
            --cr-text: #ffffff;
        }

        body {
            background-color: var(--cr-dark-grey);
            color: var(--cr-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .anime-card {
            background-color: var(--cr-black);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            cursor: pointer;
        }

        .anime-card:hover {
            transform: translateY(-8px);
            border-color: var(--cr-orange);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .btn-primary {
            background-color: var(--cr-orange);
            color: white;
            transition: filter 0.2s;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .modal-bg {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }

        .poster-container {
            aspect-ratio: 2 / 3;
            width: 100%;
            overflow: hidden;
            background-color: #1a1a1a;
        }

        .poster-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .star-input {
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .star-input.active {
            color: #ffc107;
        }
        
        .star-input.inactive {
            color: #4b5563;
        }

        .filter-active {
            color: white !important;
            border-color: var(--cr-orange) !important;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--cr-dark-grey); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cr-orange); }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Header -->
    <header class="bg-[#23252b] border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fas fa-layer-group text-3xl text-[#f47521]"></i>
                <h1 class="text-2xl font-black tracking-tighter uppercase italic">D <span class="text-[#f47521]">Tracker</span></h1>
            </div>
            <button onclick="openModal()" class="btn-primary px-4 py-2 rounded font-bold uppercase text-sm flex items-center gap-2">
                <i class="fas fa-plus"></i> Nueva Serie
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-8">
        <!-- Filtros de Estado -->
        <div class="flex flex-wrap gap-4 mb-4 overflow-x-auto pb-2 no-scrollbar border-b border-gray-800">
            <button onclick="setFilterStatus('all')" id="status-all" class="filter-btn-status text-white font-bold border-b-2 border-[#f47521] px-2 py-1 transition-all">Todos</button>
            <button onclick="setFilterStatus('visto')" id="status-visto" class="filter-btn-status text-gray-400 hover:text-white font-bold border-b-2 border-transparent px-2 py-1 transition-all">Vistos</button>
            <button onclick="setFilterStatus('pendiente')" id="status-pendiente" class="filter-btn-status text-gray-400 hover:text-white font-bold border-b-2 border-transparent px-2 py-1 transition-all">Por Ver</button>
        </div>

        <!-- Filtros de Evaluación (Estrellas) -->
        <div class="flex flex-wrap items-center gap-4 mb-8 overflow-x-auto pb-2 no-scrollbar">
            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Filtrar por Nota:</span>
            <button onclick="setFilterRating('all')" id="rating-all" class="filter-btn-rating text-white bg-gray-800 px-3 py-1 rounded-full text-xs font-bold border border-[#f47521]">Cualquiera</button>
            <div class="flex gap-2">
                <button onclick="setFilterRating(1)" id="rating-1" class="filter-btn-rating text-gray-400 bg-gray-800 px-3 py-1 rounded-full text-xs font-bold border border-transparent hover:border-gray-600 transition-all flex items-center gap-1">1 <i class="fas fa-star text-[10px] text-yellow-500"></i></button>
                <button onclick="setFilterRating(2)" id="rating-2" class="filter-btn-rating text-gray-400 bg-gray-800 px-3 py-1 rounded-full text-xs font-bold border border-transparent hover:border-gray-600 transition-all flex items-center gap-1">2 <i class="fas fa-star text-[10px] text-yellow-500"></i></button>
                <button onclick="setFilterRating(3)" id="rating-3" class="filter-btn-rating text-gray-400 bg-gray-800 px-3 py-1 rounded-full text-xs font-bold border border-transparent hover:border-gray-600 transition-all flex items-center gap-1">3 <i class="fas fa-star text-[10px] text-yellow-500"></i></button>
                <button onclick="setFilterRating(4)" id="rating-4" class="filter-btn-rating text-gray-400 bg-gray-800 px-3 py-1 rounded-full text-xs font-bold border border-transparent hover:border-gray-600 transition-all flex items-center gap-1">4 <i class="fas fa-star text-[10px] text-yellow-500"></i></button>
                <button onclick="setFilterRating(5)" id="rating-5" class="filter-btn-rating text-gray-400 bg-gray-800 px-3 py-1 rounded-full text-xs font-bold border border-transparent hover:border-gray-600 transition-all flex items-center gap-1">5 <i class="fas fa-star text-[10px] text-yellow-500"></i></button>
            </div>
        </div>

        <!-- Grid -->
        <div id="seriesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <!-- Inyectado por JS -->
        </div>

        <!-- Estado Vacío -->
        <div id="emptyState" class="hidden text-center py-20">
            <i class="fas fa-box-open text-6xl text-gray-700 mb-4"></i>
            <p class="text-xl text-gray-500 font-medium">No hay series que coincidan con los filtros.</p>
        </div>
    </main>

    <!-- Modal Formulario -->
    <div id="modal" class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-[#23252b] w-full max-w-lg rounded-lg shadow-2xl border border-gray-800">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-bold italic uppercase">Añadir Serie</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="seriesForm" class="p-6 space-y-4">
                <input type="hidden" id="editingId" value="">
                
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-widest">Título de la Serie</label>
                    <div class="flex gap-2">
                        <input type="text" id="title" required class="flex-1 bg-[#141519] border border-gray-700 rounded p-3 focus:border-[#f47521] outline-none text-white">
                        <button type="button" onclick="autoFetchAnime()" id="magicBtn" class="bg-gray-700 hover:bg-gray-600 px-4 rounded text-[#f47521]" title="Buscar imagen automáticamente">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                    <p id="searchStatus" class="text-[10px] mt-1 text-gray-500 hidden italic">Buscando imagen...</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-widest">Estado</label>
                        <select id="status" class="w-full bg-[#141519] border border-gray-700 rounded p-3 focus:border-[#f47521] outline-none text-white">
                            <option value="pendiente">Por Ver</option>
                            <option value="visto">Visto</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-widest">Calificación</label>
                        <div id="starRatingContainer" class="flex items-center gap-1 mt-2">
                            <!-- Estrellas generadas por JS -->
                        </div>
                        <input type="hidden" id="rating" value="5">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-widest">URL del Póster</label>
                    <input type="url" id="imageUrl" placeholder="https://ejemplo.com/poster.jpg" class="w-full bg-[#141519] border border-gray-700 rounded p-3 focus:border-[#f47521] outline-none text-white text-sm">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-700 py-3 rounded font-bold uppercase tracking-widest text-sm">Cancelar</button>
                    <button type="submit" id="submitBtn" class="flex-1 btn-primary py-3 rounded font-black uppercase tracking-widest text-sm">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const DB_NAME = 'DTrackerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'series';
        let db;
        
        // Estado de los filtros globales
        let currentFilterStatus = 'all';
        let currentFilterRating = 'all';

        // Inicializar DB
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            loadSeries();
        };

        // UI Estrellas del Formulario
        function setupStarRating(initialValue = 5) {
            const container = document.getElementById('starRatingContainer');
            const ratingInput = document.getElementById('rating');
            container.innerHTML = '';
            ratingInput.value = initialValue;

            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = `fas fa-star text-xl star-input ${i <= initialValue ? 'active' : 'inactive'}`;
                star.onclick = () => updateFormRating(i);
                container.appendChild(star);
            }
        }

        function updateFormRating(val) {
            document.getElementById('rating').value = val;
            const stars = document.querySelectorAll('.star-input');
            stars.forEach((star, index) => {
                if (index < val) {
                    star.classList.add('active');
                    star.classList.remove('inactive');
                } else {
                    star.classList.remove('active');
                    star.classList.add('inactive');
                }
            });
        }

        // Búsqueda de imagen
        async function autoFetchAnime() {
            const titleInput = document.getElementById('title');
            const urlInput = document.getElementById('imageUrl');
            const statusText = document.getElementById('searchStatus');
            const magicBtn = document.getElementById('magicBtn');

            if (!titleInput.value.trim()) return;

            try {
                statusText.classList.remove('hidden');
                statusText.innerText = "Buscando imagen...";
                magicBtn.disabled = true;

                const response = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(titleInput.value)}&limit=1`);
                const result = await response.json();

                if (result.data && result.data.length > 0) {
                    const anime = result.data[0];
                    urlInput.value = anime.images.jpg.large_image_url || anime.images.jpg.image_url;
                    statusText.innerText = "¡Imagen encontrada!";
                    statusText.classList.add('text-green-500');
                } else {
                    statusText.innerText = "No se encontró imagen.";
                    statusText.classList.add('text-red-500');
                }
            } catch (err) {
                statusText.innerText = "Error de conexión.";
            } finally {
                magicBtn.disabled = false;
                setTimeout(() => {
                    statusText.classList.add('hidden');
                    statusText.classList.remove('text-green-500', 'text-red-500');
                }, 3000);
            }
        }

        // Modal Handlers
        function openModal(editId = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('seriesForm');
            const title = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtn');
            
            form.reset();
            document.getElementById('editingId').value = '';
            title.innerText = "Añadir Serie";
            submitBtn.innerText = "Guardar";
            setupStarRating(5);

            if (editId) {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const getReq = store.get(Number(editId));
                
                getReq.onsuccess = () => {
                    const data = getReq.result;
                    document.getElementById('editingId').value = data.id;
                    document.getElementById('title').value = data.title;
                    document.getElementById('status').value = data.status;
                    document.getElementById('imageUrl').value = data.imageUrl.includes('placeholder') ? '' : data.imageUrl;
                    setupStarRating(data.rating || 5);
                    title.innerText = "Editar Serie";
                    submitBtn.innerText = "Actualizar";
                };
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // Lógica de Filtros
        function setFilterStatus(status) {
            currentFilterStatus = status;
            // Actualizar UI
            document.querySelectorAll('.filter-btn-status').forEach(btn => {
                btn.classList.remove('text-white', 'border-[#f47521]');
                btn.classList.add('text-gray-400', 'border-transparent');
            });
            document.getElementById(`status-${status}`).classList.add('text-white', 'border-[#f47521]');
            document.getElementById(`status-${status}`).classList.remove('text-gray-400', 'border-transparent');
            
            loadSeries();
        }

        function setFilterRating(rating) {
            currentFilterRating = rating;
            // Actualizar UI
            document.querySelectorAll('.filter-btn-rating').forEach(btn => {
                btn.classList.remove('text-white', 'border-[#f47521]');
                btn.classList.add('text-gray-400', 'border-transparent');
            });
            document.getElementById(`rating-${rating}`).classList.add('text-white', 'border-[#f47521]');
            document.getElementById(`rating-${rating}`).classList.remove('text-gray-400', 'border-transparent');
            
            loadSeries();
        }

        // CRUD
        document.getElementById('seriesForm').onsubmit = (e) => {
            e.preventDefault();
            const editingId = document.getElementById('editingId').value;
            const data = {
                title: document.getElementById('title').value,
                status: document.getElementById('status').value,
                rating: parseInt(document.getElementById('rating').value),
                imageUrl: document.getElementById('imageUrl').value || 'https://via.placeholder.com/300x450?text=No+Image',
                updatedAt: new Date().toISOString()
            };

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            if (editingId) {
                data.id = Number(editingId);
                store.put(data);
            } else {
                data.createdAt = new Date().toISOString();
                store.add(data);
            }

            transaction.oncomplete = () => {
                closeModal();
                loadSeries();
            };
        };

        function loadSeries() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                let series = request.result;
                
                // Aplicar Filtro de Estado
                if (currentFilterStatus !== 'all') {
                    series = series.filter(s => s.status === currentFilterStatus);
                }
                
                // Aplicar Filtro de Calificación
                if (currentFilterRating !== 'all') {
                    series = series.filter(s => s.rating === currentFilterRating);
                }

                renderGrid(series);
            };
        }

        function renderGrid(series) {
            const grid = document.getElementById('seriesGrid');
            const empty = document.getElementById('emptyState');
            grid.innerHTML = '';
            
            if (series.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            series.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));

            series.forEach(item => {
                const card = document.createElement('div');
                card.className = 'anime-card rounded overflow-hidden relative group flex flex-col shadow-lg';
                
                let stars = '';
                const rating = item.rating || 0;
                for(let i=1; i<=5; i++) {
                    stars += `<i class="${i <= rating ? 'fas' : 'far'} fa-star text-[10px] text-yellow-500"></i>`;
                }

                card.innerHTML = `
                    <div class="poster-container" onclick="openModal(${item.id})">
                        <img src="${item.imageUrl}" alt="${item.title}" class="poster-image transition-transform duration-500 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/300x450?text=Error+Imagen'">
                    </div>
                    <div class="p-3 flex-grow" onclick="openModal(${item.id})">
                        <h3 class="font-bold text-sm truncate mb-1 text-white">${item.title}</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] uppercase font-black tracking-widest ${item.status === 'visto' ? 'text-green-400' : 'text-blue-400'}">
                                ${item.status === 'visto' ? 'Visto' : 'Por Ver'}
                            </span>
                            <div class="flex gap-0.5 items-center">
                                ${stars}
                            </div>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteSeries(${item.id})" class="absolute top-2 right-2 bg-black/80 w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white hover:text-red-500 shadow-lg">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                    <div class="absolute top-2 left-2 bg-[#f47521] px-2 py-0.5 rounded text-[9px] font-bold uppercase opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                        Editar
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function deleteSeries(id) {
            if(!confirm('¿Eliminar esta serie de D Tracker?')) return;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.delete(id);
            transaction.oncomplete = () => loadSeries();
        }

        // Inicializar UI de estrellas al cargar
        setupStarRating(5);
    </script>
</body>
</html>